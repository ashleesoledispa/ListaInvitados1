@model IEnumerable<ListaInvitados1.Models.Invitado>

@{
    ViewData["Title"] = "Invitados Trick or Drink";
}

<style>
    body {
        background-color: #000;
        color: #fff;
        font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 0;
    }

    h2 {
        text-align: center;
        margin: 40px 0 20px 0;
        font-size: 1.9rem;
        color: #D70B01;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: capitalize;
    }

    .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-control {
        background-color: #111;
        border: 1px solid #2a2a2a;
        color: #fff;
        border-radius: 10px;
        padding: 12px;
        font-size: 1rem;
        transition: border 0.2s ease;
    }

        .form-control:focus {
            outline: none;
            border-color: #D70B01;
        }

        .form-control::placeholder {
            color: #888;
        }

    /* BOTONES */
    .btn {
        border-radius: 10px;
        border: none;
        padding: 10px 18px;
        cursor: pointer;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: 0.2s ease;
        background-color: #D70B01;
        color: #fff;
    }

        .btn:hover {
            background-color: #222;
            transform: scale(1.03);
        }

        .btn:active {
            transform: scale(0.98);
        }

    /* TABLA */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        color: #fff;
        border-radius: 10px;
        overflow: hidden;
        background-color: #0d0d0d;
    }

    thead {
        background-color: #1a1a1a;
    }

        thead th {
            color: #D70B01;
            text-align: left;
            font-weight: 600;
            padding: 12px 14px;
            font-size: 0.95rem;
            border-bottom: 1px solid #2a2a2a;
        }

    tbody td {
        padding: 10px 14px;
        font-size: 0.95rem;
        color: #fff;
        border-bottom: 1px solid #1b1b1b;
    }

    tr:last-child td {
        border-bottom: none;
    }

    tr:hover td {
        background-color: #111;
    }

    .text-center {
        text-align: center;
    }

    textarea {
        background-color: #111;
        border: 1px solid #2a2a2a;
        color: #fff;
        border-radius: 10px;
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        transition: border 0.2s;
    }

        textarea:focus {
            outline: none;
            border-color: #D70B01;
        }

    /* CONTADOR */
    .counter {
        text-align: center;
        margin-bottom: 12px;
        font-size: 1rem;
        color: #D70B01;
        font-weight: 500;
    }

    /* RESPONSIVE */
    @@media (max-width: 600px) {
        h2

    {
        font-size: 1.5rem;
    }

    .btn {
        width: 100%;
    }

    }
</style>

<div class="container">
    <h2>Invitados Trick or Drink</h2>

    <!-- CONTADOR -->
    <div id="contador" class="counter"></div>

    <!-- BUSCADOR -->
    <div class="mb-3">
        <input type="text" id="buscador" class="form-control" placeholder="Buscar por nombre..." />
    </div>

    <!-- BOTONES -->
    <div class="d-flex justify-content-center gap-2 mb-3" style="display:flex; gap:10px; justify-content:center;">
        <button id="btnVerLista" class="btn">Ver lista completa</button>
        <button id="btnImportar" class="btn">Importar lista</button>
    </div>

    <!-- FORMULARIO DE IMPORTACIÓN -->
    <div id="importarContainer" style="display:none;" class="mt-3">
        <form asp-action="Importar" method="post">
            <textarea name="nombres" rows="6" placeholder="Pega aquí los nombres, uno por línea..."></textarea>
            <button type="submit" class="btn mt-2">Guardar lista</button>
        </form>
    </div>

    <!-- TABLA -->
    <table id="tablaContainer" style="display:none;">
        <thead>
            <tr>
                <th>Nombre</th>
                <th class="text-center">Registrado</th>
            </tr>
        </thead>
        <tbody id="tablaInvitados">
            @foreach (var item in Model)
            {
                <tr data-nombre="@item.Nombre" data-id="@item.Id">
                    <td>@item.Nombre</td>
                    <td class="text-center">
                        <input type="checkbox" class="checkRegistro" @(item.Registrado ? "checked" : "") />
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // =========================
        // Normalizar texto (sin tildes ni mayúsculas)
        // =========================
        function normalize(text) {
            return text
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        }

        // =========================
        // Elementos base
        // =========================
        const tabla = document.getElementById("tablaContainer");
        const importar = document.getElementById("importarContainer");
        const btnVerLista = document.getElementById("btnVerLista");
        const btnImportar = document.getElementById("btnImportar");
        const buscador = document.getElementById("buscador");
        const contador = document.getElementById("contador");

        // =========================
        // Mostrar / ocultar secciones
        // =========================
        btnVerLista.addEventListener("click", () => {
            importar.style.display = "none";
            tabla.style.display = (tabla.style.display === "none") ? "table" : "none";
        });

        btnImportar.addEventListener("click", () => {
            tabla.style.display = "none";
            importar.style.display = (importar.style.display === "none") ? "block" : "none";
        });

        // =========================
        // Búsqueda en vivo
        // =========================
        buscador.addEventListener("keyup", function () {
            const texto = normalize(buscador.value);
            const filas = document.querySelectorAll("#tablaInvitados tr");

            if (texto.length > 0) tabla.style.display = "table";

            filas.forEach(row => {
                const nombre = normalize(row.getAttribute("data-nombre"));
                row.style.display = nombre.includes(texto) ? "" : "none";
            });
        });

        // =========================
        // Actualizar contador dinámico
        // =========================
        function actualizarContador() {
            const total = document.querySelectorAll("#tablaInvitados tr").length;
            const registrados = document.querySelectorAll(".checkRegistro:checked").length;
            contador.textContent = `${registrados} de ${total} personas registradas`;
        }

        // Inicializar contador
        actualizarContador();

        // =========================
        // Cambiar estado de check
        // =========================
        document.querySelectorAll(".checkRegistro").forEach(chk => {
            chk.addEventListener("change", function () {
                const fila = this.closest("tr");
                const id = fila.getAttribute("data-id");
                const registrado = this.checked;

                fetch("/Invitados/CambiarEstado", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken":
                            document.querySelector('input[name="__RequestVerificationToken"]')?.value ?? ""
                    },
                    body: JSON.stringify({ id, registrado })
                });

                actualizarContador();
            });
        });
    </script>
}
